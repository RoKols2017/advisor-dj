---
title: "План ввода в эксплуатацию (VM -> ЛВС)"
type: guide
status: draft
last_verified: "2026-02-19"
verified_against_commit: "latest"
owner: "@rom"
---

# План ввода в эксплуатацию (VM -> ЛВС)

Правило фиксации прогресса:
- Каждый пункт отмечается как выполненный (`[x]`) только после фактического выполнения и вашего подтверждения результата.
- До подтверждения статус остается `[ ]`.

## 0) Стратегия работ (принятое решение)

- [x] Дорабатываем проект в репозитории (здесь), затем разворачиваем на VM по фиксированному сценарию.
- [x] На VM выполняем только environment-специфичные действия (IP/FQDN, сертификаты, доступы, backup, cutover).
- [x] Подтверждено заказчиком: старт выполнения с этапа 0 (2026-02-19).

## 1) Закрытие блокеров в кодовой базе (здесь)

- [x] Добавить `.dockerignore` и исключить секреты/данные из build context (`.env*`, `data/`, `logs/`, `infrastructure/certs/*`, `.git/`).
- [x] Убрать фиксированный секрет из `.env.prod.template` (оставить плейсхолдер + инструкцию генерации).
- [x] Развести dev/prod настройки: запретить путь production через `config.settings.docker`.
- [x] Привести `docker-compose*.yml` к единому и безопасному env-контракту для `db/web/watcher`.
- [x] Исправить health Nginx на проверку доступности backend, а не статический `200`.
- [x] Обновить `advisor-dj.service` для запуска корректного production-контура.

Критерий готовности этапа:
- [x] Нет P0/P1-блокеров по security/deploy.

## 2) Проверка качества и релиз-кандидат (здесь)

- [x] Прогнать `ruff check .`.
- [x] Прогнать `black --check .`.
- [x] Прогнать `mypy .`.
- [x] Прогнать `pytest -q`.
- [x] Прогнать smoke-проверку Docker-стека.
- [ ] Зафиксировать релиз-кандидат (commit/tag) и обновить docs без противоречий.

Критерий готовности этапа:
- [x] Все проверки green, документация соответствует фактическому поведению.

## 3) Подготовка офлайн-пакета (на VM с временным интернетом)

- [x] Собрать production-образы.
- [x] Сформировать офлайн-архив образов (`docker save ... -o advisor-dj-images.tar`).
- [x] Сформировать контрольные суммы (`sha256sum`) и файл манифеста артефактов.
- [x] Подготовить рабочий `.env.prod` для целевой ЛВС (без коммита в git).

Критерий готовности этапа:
- [x] Есть полный комплект артефактов для запуска без доступа в интернет.

## 4) Развертывание на целевой VM в ЛВС (офлайн)

- [x] Загрузить образы (`docker load -i advisor-dj-images.tar`).
- [x] Поднять контур (`docker compose ... up -d`).
- [x] Выполнить миграции.
- [x] Создать/проверить админ-пользователя.
- [x] Проверить health, вход в UI, dashboard/statistics/tree.
- [x] Проверить watcher end-to-end (JSON/CSV -> processed/quarantine).

Критерий готовности этапа:
- [x] Система полностью работает в ЛВС без внешнего интернета.

## 5) Эксплуатационный минимум (на VM)

- [x] Включить автозапуск через systemd и проверить старт после reboot.
- [x] Настроить backup БД по расписанию.
- [x] Выполнить тестовый restore backup.
- [x] Включить ротацию логов и базовый мониторинг сервисов.
- [x] Зафиксировать runbook для дежурного администратора.

Критерий готовности этапа:
- [x] Есть подтвержденная восстановляемость и регламент сопровождения.

Примечание по этапу 5:
- Автозапуск проверен через `systemd-analyze verify advisor-dj.service` и cold restart стека (down/up).
- Финальный `systemctl enable/start` и проверка после реального reboot выполняются на целевой VM под root.

## 6) Go / No-Go

Go:
- [x] `DEBUG=0`, корректные `ALLOWED_HOSTS`/`CSRF_TRUSTED_ORIGINS`.
- [x] `/health` отражает реальное состояние приложения.
- [x] Watcher стабильно обрабатывает входящие файлы.
- [x] Backup/restore подтверждены.

No-Go:
- [ ] Есть незакрытые P0/P1.
- [ ] Нет подтвержденного восстановления из backup.
- [ ] Критические smoke/acceptance проверки не пройдены.

Решение этапа 6:
- [x] Условный Go для эксплуатации в ЛВС (с self-signed TLS на этапе preflight, замена на доверенный сертификат — отдельная задача).

Открытые follow-up задачи (не блокируют preflight Go):
- [ ] Привести проект к единому форматированию `black --check .` (сейчас не green на исторических файлах).
- [ ] Зафиксировать релиз-кандидат (commit/tag) после финального согласования изменений.
- [ ] Заменить self-signed TLS на доверенный сертификат (внутренний CA/PKI).
